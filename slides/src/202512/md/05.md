---
layout: section
---

# **Catalyst**
### An API specification developed for simulations (and other scientific data
### producers) to analyze and visualize data in situ

---
level: 2
---

### ParaView Catalyst: an in-situ API with support for an ABI interface
<br>

ParaView-Catalyst is an implementation of the Catalyst `in situ API` that
uses ParaView for data processing and rendering.

**[ParaView-Catalyst]** supports a subset of the **[Mesh Blueprint]**. Simulations
that can use the Mesh Blueprint to describe their data can directly use
ParaView\'s Catalyst implementation for in situ analysis and visualization.

```c
enum catalyst_status catalyst_initialize(const conduit_node* params);
enum catalyst_status catalyst_finalize(const conduit_node* params);
enum catalyst_status catalyst_execute(const conduit_node* params);

// Optional:
enum catalyst_status catalyst_results(conduit_node* params);
enum catalyst_status catalyst_about(conduit_node* params);
```

- **[ParaView-Catalyst In-situ docs]**
- **[ParaView-Catalyst Blueprint]**

[ParaView-Catalyst]: https://docs.paraview.org/en/latest/Catalyst/background.html
[Mesh Blueprint]: https://llnl-conduit.readthedocs.io/en/latest/blueprint_mesh.html#mesh-blueprint
[ParaView-Catalyst In-situ docs]: https://catalyst-in-situ.readthedocs.io

---
layout: section
---

# Conduit + ParaView Catalyst

---
level: 2
---

# The ParaView Catalyst Python scripts

- An interactive session with the ParaView application with a representative
template input file, and a set of visualization filters can be tuned by the
user in an _offline_ fashion \[not connected to a running solver\]

- ParaView provides hybrid parallelism out-of-the-box
    - MPI-enabled
    - SMP multi-threading
    - CUDA-enabled filters

- The Python scripts are completely interchangeable between the batch-mode
ParaView execution (reading data from disk), and the in-situ execution

---
level: 2
---
## Generate a script from the ParaView GUI

- Start ParaView client locally
- read, or generate a dataset similar to what we're going to compute
- example: The Heat diffusion, generates a variable called "Temperature" in a 2D grid
<div grid="~ cols-2 gap-4" class="mt-4">

 <div class="col-span-1">
```python
# Creates a scalar field called "DistanceSquared"
UniformGrid1 = FastUniformGrid(registrationName='grid')
# normalize and rename to "Temperature"
pythonCalculator1 = PythonCalculator(Input=UniformGrid1)
pythonCalculator1.Set(
    Expression='DistanceSquared/max(DistanceSquared)',
    ArrayName='Temperature')

# create a new 'Contour'
contour1 = Contour(Input=pythonCalculator1)
contour1.Set(
    ContourBy=['POINTS', 'Temperature'],
    ComputeNormals=0,
    Isosurfaces=[i/10. for i in range(10)])
```
 </div>
  <div class="col-span-1">
<img src="/img//Temperature-Catalyst.40000.png" style="width: 20vw; min-width: 300px;">
 </div>
</div>

---
level: 2
---
## Catalyst-specific script

<div grid="~ cols-2 gap-4" class="mt-4">

 <div class="col-span-1">
```python
# create extractor
pNG1 = CreateExtractor('PNG', renderView1, registrationName='PNG1')
pNG1.Trigger.Frequency = 50
pNG1.Writer.Set(
    FileName='Temperature_{timestep:06d}{camera}.png',
    ImageResolution=[512, 512],
    Format='PNG',)

from paraview import catalyst
options = catalyst.Options()
options.GlobalTrigger.Frequency = 50
options.EnableCatalystLive = 1
options.CatalystLiveURL = 'daint-ln004'
```
 </div>
  <div class="col-span-1">
<img src="/img//Temperature-Catalyst.40000.png" style="width: 20vw; min-width: 300px;">
 </div>
</div>

---
level: 2
---

## Catalyst scripts (batch-mode vs. in-situ mode)
<br>

<div grid="~ cols-2 gap-4" class="mt-4">

 <div class="col-span-1">
```python
grid = OpenDataFile(registrationName='grid',
 filename=['temperature_001000.vti'])

renderView1 = GetRenderView()
rep = Show()
ColorBy(rep, ['POINTS', 'Temperature'])
Render()

 # execute in batch-mode with data read from disk
  from paraview.simple import
       SaveExtractsUsingCatalystOptions
  SaveExtractsUsingCatalystOptions(options)
```
 </div> 

 <div class="col-span-1">
```python
 grid = TrivialProducer(registrationName='grid')

 
  renderView1 = GetRenderView()
  rep = Show()
  ColorBy(rep, ['POINTS', 'Temperature'])
  v = CreateExtractor('VTPD', grid)

  v.Trigger = 'TimeStep'
  v.Trigger.Frequency = 30
  v.Writer.FileName = 'Temperature_{timestep:06d}.vtpd'
```
 </div>
</div>

---
level: 2
---

## ParaView-Catalyst Blueprint
<br>

- Defines the options accepted by `catalyst_initialize()`, these include things
like ParaView Python scripts to load, directories to save data

```python
node["catalyst/scripts/script/filename"] = ...
```

- Defines the protocol for `catalyst_execute()` and includes information about
Catalyst channels i.e. ports on which data is made available

```python
node["catalyst/state/cycle"] =
node["catalyst/state/time"] =

node["catalyst/channels/grid/type"] = "mesh"
node["catalyst/channels/grid/data"] =
```

- Defines the protocol for `catalyst_finalize()`

---
level: 2
---

## Code instrumentation

<div grid="~ cols-2 gap-4" class="mt-4">
 <div class="col-span-1">
```c
// without Catalyst:
int main(int argc, char** argv) {
  MPI_Init_and_Code_Init();

  for (d.iteration = 0; d.iteration <= maxStep;
       d.iteration++) {
    Solve_For_Each_Timestep();


  }

  return exitSuccess();
}
```

- The Catalyst glue code for the SPH-EXA solver is 144 lines of code

- Enabling in-situ visualization can be optionally compiled
 </div>
 <div class="col-span-1">
```c
  #include "CatalystAdaptor.h"
  int main(int argc, char** argv) {
    MPI_Init_and_Code_Init();
    CatalystAdaptor::Initialize(argc, argv);
    for (d.iteration = 0; d.iteration <= maxStep;
         d.iteration++) {
      Solve_For_Each_Timestep();
      CatalystAdaptor::Execute(
        d, domain.startIndex());
    }
    CatalystAdaptor::Finalize();
    return exitSuccess();
  }
```

- The execution driver is instrumented with 4 lines of code (Initialize,
Execute, Finalize)

- Total: 148 lines of code
 </div>
</div>

---
level: 2
---

## What about "Operations Control"?

<div grid="~ cols-2 gap-4" class="mt-4">
 <div class="col-span-1">

- **Adaptive Control**
    - Choose different pathes of execution based on queries/triggers
    - The catalyst_execute(ConduitNode) script can be customized

 </div>
 <div class="col-span-1 w-40 ml-40">
   <img src="/img/05_threshold.png" />
 </div>
</div>

```python    
def catalyst_execute(node):
  threshold = 1.4
  if reader.PointData[“Density”].GetRange()[1] > threshold:
     print(“density at timestep”, node.timestep)
     # Extract particles where Density > threshold
  else:
     # use ALL particles
```

---
level: 2
---

## ParaView pipeline vs. Ascent pipeline

<div grid="~ cols-2 gap-4" class="mt-4">
 <div class="col-span-1">
```python
# ParaView pipeline

renderView1 = CreateView('RenderView')

selection=SelectPoints()
selection.QueryString = "Density >= 1.4"

extractSelection = ExtractSelection()
thresholdDisplay = Show(extractSelection)
ColorBy(thresholdDisplay, ['POINTS', 'Density'])

pNG1 = CreateExtractor('PNG', renderView1)
pNG1.Trigger = 'TimeStep'
pNG1.Writer.FileName =
    'threshold_{timestep:06d}{camera}.png'
pNG1.Trigger.Frequency = 100
```
 </div>

 <div class="col-span-1">
```yaml
// Ascent pipeline (YAML)
-
  action: "add_scenes"
  scenes:
    s1:
      plots:
        p1:
          type: "pseudocolor"
          field: "Density"
          pipeline: "pl_threshold"
      renders:
        r1:
          image_prefix: "datasets/threshold_.%05d"
-
  action: "add_pipelines"
  pipelines:
    pl_threshold:
      f1:
        type: "threshold"
        params:
          field: "Density"
          min_value: 1.4
          max_value: 2000 

```
 </div>
</div>

---
level: 2
---

## Connection LIVE to a running simulation

- Recall previous page on definining a catalyst script
- that script can ru in batch mode, generating images and extracts at the given frequencies.
- with the following code, we can accept a request for connection from an external client
```python
from paraview import catalyst
options = catalyst.Options()
options.GlobalTrigger.Frequency = 50
options.EnableCatalystLive = 1
options.CatalystLiveURL = 'daint-ln004'
```
<br>
- start ParaView client and Catalyst=>connect()<br>
- ssh -R 22222:localhost:22222 daint-ln004<br>
- sbatch run_catalyst.sh<br>
- Live demo

---
level: 2
---

# Summary
<br>

- Introduced two Conduit-based solutions, enabling
    - `ParaView Catalyst`, or
    - `Ascent`, as filtering and rendering engines.
- `Ascent` deployment is driven by many examples in the doc to generate *YAML* scripts
- `ParaView Catalyst` can use the ParaView client to generate *Python* scripts
- Main problem: it is an N-to-N mapping:<br>
<v-click>&nbsp;&nbsp;&nbsp; - visualization algorithms probably don't scale with the same granularity of simulations</v-click><br>
<v-click>&nbsp;&nbsp;&nbsp; - The simulation waits while visualization steps take place</v-click>



